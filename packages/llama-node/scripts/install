#!/bin/bash
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

cd $SCRIPT_DIR
cd ../

if [[ -f "../../packages/llama.cpp/CMakeLists.txt" ]]; then
  export LLAMA_CPP_SOURCE="$( cd ../../packages/llama.cpp && pwd )"
else
  LANG_VECTOR_PATH="$( node -p "require('@o2ter/lang-vector').include.slice(1,-1)" )"
  if [[ -f "${LANG_VECTOR_PATH}/packages/llama.cpp/CMakeLists.txt" ]]; then
    export LLAMA_CPP_SOURCE="$( cd ${LANG_VECTOR_PATH}/packages/llama.cpp && pwd )"
  fi
fi

if [[ -z "${LLAMA_CPP_SOURCE}" ]]; then
  echo "Package llama.cpp not found" 1>&2
  exit 1
fi

EXTRA_OPTIONS=""

if [[ -x "$(command -v nvcc)" ]]; then
  EXTRA_OPTIONS="${EXTRA_OPTIONS} --CDGGML_CUDA=ON"
elif [[ -x "$(command -v vulkaninfo)" ]]; then
  EXTRA_OPTIONS="${EXTRA_OPTIONS} --CDGGML_VULKAN=ON"
fi

if [[ -n "${TARGET_ARCH}" && "${TARGET_ARCH}" != "$(uname -m)" ]]; then
  TOOLCHAIN_DIR="$( cd ../../toolchains && pwd )"
  EXTRA_OPTIONS="${EXTRA_OPTIONS} --CDCMAKE_TOOLCHAIN_FILE=${TOOLCHAIN_DIR}/$(uname -s | tr '[:upper:]' '[:lower:]').target-${TARGET_ARCH}.cmake"
fi

cmake-js compile --CDLLAMA_CPP_SOURCE=${LLAMA_CPP_SOURCE} ${EXTRA_OPTIONS}